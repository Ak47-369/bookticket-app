name: Sync External Microservice READMEs

on:
  push:
    branches:
      - main
  workflow_dispatch:
permissions:
  contents: write
jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3

      - name: Build README.md from template + external repos
        run: |
          cp README.template.md README.md

          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "# ðŸ“Œ Microservices Documentation" >> README.md
          echo "" >> README.md

          fetch_readme () {
            RAW_URL=$1
            NAME=$2

            echo "## ðŸ”¹ $NAME" >> README.md
            echo "" >> README.md

            curl -L "$RAW_URL" -o TEMP_README.md

            if [ -s TEMP_README.md ]; then
              cat TEMP_README.md >> README.md
            else
              echo "_README not found for $NAME._" >> README.md
            fi

            echo "" >> README.md
            echo "---" >> README.md
            echo "" >> README.md
          }

          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-config-server/main/README.md" "Config Server"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-eureka-server/main/README.md" "Service Registry"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-api-gateway/main/README.md" "API Gateway"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-user-service/main/README.md" "User Service"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-movie-service/main/README.md" "Movie Service"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-theater-service/main/README.md" "Theater Service"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-booking-service/main/README.md" "Booking Service"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-payment-service/main/README.md" "Payment Service"
          fetch_readme "https://raw.githubusercontent.com/Ak47-369/bookticket-notification-service/main/README.md" "Notification Service"

      - name: Commit & Push updated README.md
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add README.md
          git commit -m "Auto-sync README from external microservices" || echo "No changes to commit"
          git push
