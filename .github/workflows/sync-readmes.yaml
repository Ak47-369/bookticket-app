name: Sync External Microservice READMEs

on:
  push:
    branches:
      - main
  workflow_dispatch:
permissions:
  contents: write
jobs:
  sync-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Monorepo
        uses: actions/checkout@v3
      - name: Clone External Microservice Repos
        run: |
          mkdir microservices

          declare -A repos=(
            ["CONFIG_SERVER"]="https://github.com/Ak47-369/bookticket-config-server"
            ["EUREKA_SERVER"]="https://github.com/Ak47-369/bookticket-eureka-server"
            ["API_GATEWAY"]="https://github.com/Ak47-369/bookticket-api-gateway"
            ["USER_SERVICE"]="https://github.com/Ak47-369/bookticket-user-service"
            ["MOVIE_SERVICE"]="https://github.com/Ak47-369/bookticket-movie-service"
            ["THEATER_SERVICE"]="https://github.com/Ak47-369/bookticket-theater-service"
            ["BOOKING_SERVICE"]="https://github.com/Ak47-369/bookticket-booking-service"
            ["PAYMENT_SERVICE"]="https://github.com/Ak47-369/bookticket-payment-service"
            ["NOTIFICATION_SERVICE"]="https://github.com/Ak47-369/bookticket-notification-service"
          )

          for key in "${!repos[@]}"; do
            echo "Cloning ${repos[$key]}"
            git clone --depth 1 "${repos[$key]}" "microservices/$key"
          done

      - name: Generate README.md from Template
        run: |
          cp README.template.md README.md

          for key in CONFIG_SERVER EUREKA_SERVER API_GATEWAY USER_SERVICE \
                     MOVIE_SERVICE THEATER_SERVICE BOOKING_SERVICE \
                     PAYMENT_SERVICE NOTIFICATION_SERVICE
          do
            echo "Injecting README for $key"

            if [ -f "microservices/$key/README.md" ]; then
              CONTENT=$(sed 's/\\/\\\\/g' microservices/$key/README.md | sed ':a;N;$!ba;s/\n/\\n/g')
              sed -i "s|<!-- INJECT: $key -->|$CONTENT|g" README.md
            else
              sed -i "s|<!-- INJECT: $key -->|⚠️ README.md missing in $key repo|g" README.md
            fi
          done

      - name: Commit & Push README
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add README.md || true
          git commit -m "Auto-sync README (external microservice docs)" || exit 0
          git push origin main

