name: Sync Monorepo README

on:
  push:
    paths:
      - "README.template.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Generate README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMPLATE_FILE="README.template.md"
          OUTPUT_FILE="README.md"
          TMP_DIR="svc_tmp"

          # Hardcoded repo URLs
          declare -A repos=(
            ["CONFIG_SERVER"]="https://github.com/Ak47-369/bookticket-config-server"
            ["EUREKA_SERVER"]="https://github.com/Ak47-369/bookticket-eureka-server"
            ["API_GATEWAY"]="https://github.com/Ak47-369/bookticket-api-gateway"
            ["USER_SERVICE"]="https://github.com/Ak47-369/bookticket-user-service"
            ["MOVIE_SERVICE"]="https://github.com/Ak47-369/bookticket-movie-service"
            ["THEATER_SERVICE"]="https://github.com/Ak47-369/bookticket-theater-service"
            ["BOOKING_SERVICE"]="https://github.com/Ak47-369/bookticket-booking-service"
            ["PAYMENT_SERVICE"]="https://github.com/Ak47-369/bookticket-payment-service"
            ["NOTIFICATION_SERVICE"]="https://github.com/Ak47-369/bookticket-notification-service"
          )

          echo "ðŸ“„ Copying template..."
          cp "$TEMPLATE_FILE" "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          echo "## ðŸ“¦ Microservices Documentation" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          for key in "${!repos[@]}"; do
            REPO_URL="${repos[$key]}"
            SERVICE_NAME=$(echo "$key" | tr "_" " " | sed 's/\b\(.\)/\u\1/g')

            echo "ðŸ“¥ Cloning $SERVICE_NAME ..."
            rm -rf $TMP_DIR
            git clone "https://x-access-token:${GITHUB_TOKEN}@${REPO_URL#https://}" $TMP_DIR -q

            SERVICE_README="$TMP_DIR/README.md"

            echo "<details>" >> "$OUTPUT_FILE"
            echo "<summary><strong>ðŸ“Œ $SERVICE_NAME</strong></summary>" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            echo "ðŸ”— **Repository:** $REPO_URL" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            if [ -f "$SERVICE_README" ]; then
              tail -n +1 "$SERVICE_README" >> "$OUTPUT_FILE"
            else
              echo "_No README.md found in repo_" >> "$OUTPUT_FILE"
            fi

            echo "" >> "$OUTPUT_FILE"
            echo "</details>" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
          done
          echo "" >> "$OUTPUT_FILE"
          echo "---" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "## Connect with me:" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo '<p align="left">' >> "$OUTPUT_FILE"
          echo '<a href="https://www.linkedin.com/in/amitkumar47369/" target="blank"><img align="center" src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white" height="30" /></a>' >> "$OUTPUT_FILE"
          echo '<a href="https://github.com/Ak47-369" target="blank"><img align="center" src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&logo=github&logoColor=white" height="30" /></a>' >> "$OUTPUT_FILE"
          echo '</p>' >> "$OUTPUT_FILE"
