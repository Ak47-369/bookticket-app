name: Sync Monorepo README

on:
  push:
    paths:
      - "README.template.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v3

      - name: Generate README.md
        run: |
          TEMPLATE_FILE="README.template.md"
          OUTPUT_FILE="README.md"
          TMP_DIR="svc_tmp"

          declare -A repos=(
            ["CONFIG_SERVER"]="https://github.com/Ak47-369/bookticket-config-server"
            ["EUREKA_SERVER"]="https://github.com/Ak47-369/bookticket-eureka-server"
            ["API_GATEWAY"]="https://github.com/Ak47-369/bookticket-api-gateway"
            ["USER_SERVICE"]="https://github.com/Ak47-369/bookticket-user-service"
            ["MOVIE_SERVICE"]="https://github.com/Ak47-369/bookticket-movie-service"
            ["THEATER_SERVICE"]="https://github.com/Ak47-369/bookticket-theater-service"
            ["BOOKING_SERVICE"]="https://github.com/Ak47-369/bookticket-booking-service"
            ["PAYMENT_SERVICE"]="https://github.com/Ak47-369/bookticket-payment-service"
            ["NOTIFICATION_SERVICE"]="https://github.com/Ak47-369/bookticket-notification-service"
          )

          echo "ðŸ“„ Copying template..."
          cp "$TEMPLATE_FILE" "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "## ðŸ“¦ Microservices Documentation" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          for key in "${!repos[@]}"; do
            REPO_URL="${repos[$key]}"
            SERVICE_NAME=$(echo "$key" | tr "_" " " | sed 's/\b\(.\)/\u\1/g')

            echo "ðŸ“¥ Cloning $SERVICE_NAME ..."
            rm -rf $TMP_DIR
            git clone "$REPO_URL" $TMP_DIR

            SERVICE_README="$TMP_DIR/README.md"

            echo "<details>" >> "$OUTPUT_FILE"
            echo "<summary><strong>ðŸ“Œ $SERVICE_NAME</strong></summary>" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            echo "ðŸ”— **Repository:** $REPO_URL" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            if [ -f "$SERVICE_README" ]; then
              cat "$SERVICE_README" >> "$OUTPUT_FILE"
            else
              echo "_No README.md found in repo_" >> "$OUTPUT_FILE"
            fi

            echo "" >> "$OUTPUT_FILE"
            echo "</details>" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
          done

          # Footer
          echo "" >> "$OUTPUT_FILE"
          echo "---" >> "$OUTPUT_FILE"
          echo "## Connect with me:" >> "$OUTPUT_FILE"
          echo '<p align="left">' >> "$OUTPUT_FILE"
          echo '<a href="https://www.linkedin.com/in/amitkumar47369/" target="blank"><img align="center" src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white" height="30" /></a>' >> "$OUTPUT_FILE"
          echo '<a href="https://github.com/Ak47-369" target="blank"><img align="center" src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&logo=github&logoColor=white" height="30" /></a>' >> "$OUTPUT_FILE"
          echo '</p>' >> "$OUTPUT_FILE"
      
      - name: Commit & Push README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff-index --quiet HEAD || git commit -m "Auto-sync monorepo README"
          git push
